<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URL Shortener</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    input, button { padding: 10px; margin: 5px; }
    #result { margin-top: 20px; }
    .shortener-form { display: block; }
    .short-url { display: none; }
    [data-shortcode="true"] .shortener-form { display: none; }
    [data-shortcode="true"] .short-url { display: block; }
  </style>
</head>
<body data-shortcode="">
  <div class="shortener-form">
    <h1>Personal URL Shortener</h1>
    <input type="text" id="longUrl" placeholder="Enter URL to shorten" style="width: 300px;">
    <button onclick="shortenUrl()">Shorten</button>
  </div>
  <div class="short-url" id="result"></div>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    (function() {
      let resultDiv = document.getElementById('result');
      resultDiv.innerHTML = 'Checking Firebase...';

      let db;
      if (typeof firebase === 'undefined') {
        resultDiv.innerHTML += '<br>Error: Firebase SDK not loaded. Check internet.';
        return;
      } else {
        resultDiv.innerHTML += '<br>Firebase SDK loaded';
      }
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyBBnkPe5qKDHWrPtgCBcAl4teU9W1h1qW0",
          authDomain: "g-url-shortener-64c6e.firebaseapp.com",
          projectId: "g-url-shortener-64c6e",
          storageBucket: "g-url-shortener-64c6e.firebasestorage.app",
          messagingSenderId: "786040303042",
          appId: "1:786040303042:web:d5cd682d1ef4c2ba56ba5b",
          measurementId: "G-DJYYW10D48"
        };
        firebase.initializeApp(firebaseConfig);
        resultDiv.innerHTML += '<br>Firebase initialized';
        db = firebase.firestore();
      } catch (error) {
        resultDiv.innerHTML += '<br>Init error: ' + error.message;
        return;
      }

      function generateShortCode() {
        return Math.random().toString(36).substring(2, 8);
      }

      window.shortenUrl = async function () {
        resultDiv.innerHTML += '<br>Function triggered';
        if (!db) {
          resultDiv.innerHTML += '<br>Error: Firestore not initialized';
          return;
        }
        const longUrl = document.getElementById('longUrl').value;
        if (!longUrl || !longUrl.startsWith('http')) {
          resultDiv.innerHTML += '<br>Error: Valid URL required (http/https)';
          return;
        }

        const shortCode = generateShortCode();
        resultDiv.innerHTML += '<br>Code: ' + shortCode;
        try {
          await db.collection('urls').doc(shortCode).set({
            longUrl: longUrl,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          resultDiv.innerHTML += '<br>Success: Saved ID: ' + shortCode;
          const shortUrl = window.location.origin + '/gshort/' + shortCode;
          resultDiv.innerHTML += '<br>Short URL: <a href="' + shortUrl + '">' + shortUrl + '</a>';
        } catch (error) {
          resultDiv.innerHTML += '<br>Error: ' + error.message;
        }
      };

      (async function redirect() {
        let path = window.location.pathname;
        resultDiv.innerHTML += '<br>Path: ' + path;
        let shortCode = path.replace('/gshort/', '');
        if (shortCode && shortCode.length === 6) {
          resultDiv.innerHTML += '<br>Short code: ' + shortCode;
          document.body.setAttribute('data-shortcode', 'true');
          resultDiv.innerHTML += '<br>Querying Firestore';
          try {
            const doc = await db.collection('urls').doc(shortCode).get();
            resultDiv.innerHTML += '<br>Query done, exists: ' + doc.exists;
            if (doc.exists) {
              const longUrl = doc.data().longUrl;
              resultDiv.innerHTML += '<br>Long URL: ' + longUrl;
              resultDiv.innerHTML += '<br>Redirecting...';
              window.location.replace(longUrl);
            } else {
              resultDiv.innerHTML += '<br>URL not found';
            }
          } catch (error) {
            resultDiv.innerHTML += '<br>Error: ' + error.message;
          }
        } else {
          resultDiv.innerHTML += '<br>No redirect';
        }
      })();
  })();
  </script>
</body>
</html>